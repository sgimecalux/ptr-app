<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="title">PTR</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="i18n.js"></script>
  <script src="boot.js"></script>
</head>
<body>
<header class="header-inline">
  <img id="logoHead" alt="logo">
  <h1 id="title-ptr" data-i18n="header.title">PERMISSÃO DE TRABALHO DE RISCO - PTR</h1>
</header>

<nav class="navbar">
  <a data-i18n="nav.settings" href="settings.html">Configurações</a>
  <a data-i18n="nav.dashboard" href="dashboard.html">Dashboard</a>
  <a data-i18n="nav.reports" href="reports.html">Relatórios</a>
  <a data-i18n="nav.help" href="help.html">Ajuda</a>
</nav>

<main class="steps">
  <!-- 1) Dados Iniciais -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step1.title">1) Dados Iniciais</h3>
      <span class="badge" data-i18n="badges.required">Obrigatório</span>
    </div>
    <div class="grid">
      <label class="field">
        <span data-i18n="fields.company">Empresa</span>
        <input id="empresa" type="text" value="">
      </label>

      <label class="field">
        <span data-i18n="fields.ptrcode">Código PTR (sequencial)</span>
        <input id="ptrCodigo" type="text" placeholder="PTR-00001">
      </label>

      <label class="field">
        <span data-i18n="fields.date">Data</span>
        <input id="data" type="date">
      </label>

      <label class="field">
        <span data-i18n="fields.time">Hora</span>
        <input id="hora" type="time" step="60" inputmode="numeric" pattern="[0-2][0-9]:[0-5][0-9]">
      </label>

      <label class="field">
        <span data-i18n="fields.sector">Setor</span>
        <select id="setor"></select>
      </label>

      <label class="field">
        <span data-i18n="fields.activity_desc">Atividade (descrição livre)</span>
        <input id="atividadeDesc" type="text">
      </label>
    </div>
  </section>

  <!-- 2) Tipos de Atividades -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step2.title">2) Tipos de Atividades</h3>
      <span class="badge" data-i18n="badges.select">Selecione</span>
    </div>
    <div id="listaAtividades" class="list"></div>
    <p class="muted" data-i18n="step2.hint">Edite em <strong>Configurações → Catálogos → Tipos de Atividade</strong>.</p>
  </section>

  <!-- 3) Riscos -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step3.title">3) Riscos</h3>
      <span class="badge" id="risksCount">—</span>
    </div>
    <div id="riscosContainer" class="list"></div>
  </section>

  <!-- 4) Equipamentos -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step4.title">4) Equipamentos</h3>
      <span class="badge" data-i18n="badges.select">Selecione</span>
    </div>
    <div id="listaEquip" class="list"></div>
    <p class="muted" data-i18n="step4.hint">Edite em <strong>Configurações → Catálogos → Equipamentos</strong>.</p>
  </section>

  <!-- 5) Análise de Riscos & Checklist -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step5.title">5) Análise de Riscos & Checklist</h3>
      <span class="badge" id="scoreBadge">Score: 100</span>
    </div>
    <div id="avaliacaoLista" class="list list-compact"></div>
    <p class="muted" id="scoreLegenda">100 • Itens conformes — liberar</p>
  </section>

  <!-- 6) Executantes -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step6.title">6) Executantes da Atividade</h3>
      <span class="badge" data-i18n="badges.sign_required">Assinatura obrigatória</span>
    </div>
    <div class="grid">
      <label class="field">
        <span data-i18n="fields.add_executor">Adicionar executante</span>
        <select id="selExecutante"></select>
      </label>
      <div style="align-self:end">
        <button id="addExec" class="btn primary" type="button" data-i18n="btn.add">+ Adicionar</button>
      </div>
    </div>
    <div id="execList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- 7) Responsáveis -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step7.title">7) Responsáveis da Atividade</h3>
      <span class="badge" data-i18n="badges.three_required">3 assinaturas obrigatórias</span>
    </div>
    <div class="grid">
      <label class="field"><span data-i18n="fields.emissor">Emissor</span><select id="respEmissor"></select></label>
      <label class="field"><span data-i18n="fields.leader">Líder do Setor</span><select id="respLider"></select></label>
      <label class="field"><span data-i18n="fields.team_resp">Responsável da Equipe</span><select id="respEquipe"></select></label>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="field">
        <span data-i18n="fields.sign_emissor">Assinatura Emissor</span>
        <div class="signpad" data-role="emissor"></div>
        <div class="row-actions">
          <button class="btn" data-save-role="emissor" data-i18n="btn.save_sign">Salvar assinatura</button>
          <button class="btn ghost" data-clear-role="emissor" data-i18n="btn.clear">Limpar</button>
        </div>
      </div>

      <div class="field">
        <span data-i18n="fields.sign_leader">Assinatura Líder</span>
        <div class="signpad" data-role="lider"></div>
        <div class="row-actions">
          <button class="btn" data-save-role="lider" data-i18n="btn.save_sign">Salvar assinatura</button>
          <button class="btn ghost" data-clear-role="lider" data-i18n="btn.clear">Limpar</button>
        </div>
      </div>

      <div class="field">
        <span data-i18n="fields.sign_team">Assinatura Resp. Equipe</span>
        <div class="signpad" data-role="resp"></div>
        <div class="row-actions">
          <button class="btn" data-save-role="resp" data-i18n="btn.save_sign">Salvar assinatura</button>
          <button class="btn ghost" data-clear-role="resp" data-i18n="btn.clear">Limpar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 8) Log NC -->
  <section class="card">
    <div class="card-head">
      <h3 data-i18n="step8.title">8) Log de Não Conformidades</h3>
      <span class="badge" data-i18n="badges.auto_edit">Auto + editável</span>
    </div>
    <p class="muted" data-i18n="step8.hint">Esta área mostra automaticamente tudo que você marcou como <strong>NÃO</strong> no checklist; você pode complementar.</p>
    <label class="field">
      <span data-i18n="fields.nc_items">Itens em não conformidade (um por linha)</span>
      <textarea id="logNC" class="notes" placeholder="- [Crítico] Treinamento da equipe
- Isolamento da área incompleto"></textarea>
    </label>
  </section>
</main>

<!-- Rodapé com Revisão -->
<footer class="footer-bar">
  <div class="rev-box">
    <span data-i18n="footer.rev">Revisão:</span>
    <strong id="revText">F-000 / 00 / 01/01/2025</strong>
    <button id="btnRevisar" class="btn ghost" data-i18n="btn.revise">Revisar?</button>
  </div>

  <div class="footer-actions">
    <a class="btn" href="settings.html" data-i18n="nav.settings">Configurações</a>
    <div style="display:flex;gap:8px;">
      <a class="btn" href="dashboard.html" data-i18n="nav.dashboard">Dashboard</a>
      <a class="btn" href="reports.html" data-i18n="nav.reports">Relatórios</a>
      <a class="btn" href="help.html" data-i18n="nav.help">Ajuda</a>
      <button id="btnSalvarRascunho" class="btn" data-i18n="btn.save_draft">Salvar Rascunho</button>
      <button id="btnCancelar" class="btn ghost" data-i18n="btn.cancel">Cancelar</button>
      <button id="btnConcluir" class="btn primary" data-i18n="btn.finish">Concluir (PDF + ZIP)</button>
    </div>
  </div>
</footer>

<!-- Área invisível para PDF -->
<section id="report" class="print-report">
  <div style="display:flex;align-items:center;gap:12px">
    <img id="repLogo" alt="logo" style="max-height:26px;object-fit:contain">
    <h2 style="margin:0" data-i18n="report.title">Permissão de Trabalho (PTR)</h2>
  </div>
  <div class="print-grid" style="margin-top:12px">
    <div class="print-box" id="repInfo"></div>
    <div class="print-box" id="repMeta"></div>
    <div class="print-box" id="repAtividades"></div>
    <div class="print-box" id="repRiscos"></div>
    <div class="print-box" id="repEquip"></div>
    <div class="print-box" id="repScore"></div>
    <div class="print-box" id="repExecutantes"></div>
    <div class="print-box" id="repResponsaveis"></div>
    <div class="print-box" id="repNC"></div>
    <div class="print-box" id="repCreditos"></div>
  </div>
  <p style="margin-top:10px;font-size:12px">
    <span data-i18n="report.uid">Código único:</span> <strong id="repUUID"></strong> •
    <span data-i18n="report.gen">Gerado em</span> <span id="repTs"></span><br>
    <span>SHA-256 (JSON):</span> <span id="repHash"></span>
  </p>
</section>

<script>
/* ===== util ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const read=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
const write=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const todayISO=()=>new Date().toISOString().slice(0,10);
const nowTime=()=>{const d=new Date();return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")};
const uuid=()=> (Math.random().toString(36).slice(2)+Date.now().toString(36)).toUpperCase();
async function sha256Hex(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest("SHA-256",enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("")}
function normTime(){const raw=($("#hora").value||"").replace(/\s/g,"");const m=raw.match(/^([01]\d|2[0-3]):([0-5]\d)$/);return m?`${m[1]}:${m[2]}`:nowTime()}
$("#hora").addEventListener("input",e=>e.target.value=(e.target.value||"").replace(/\s/g,""));

/* ===== keys ===== */
const K_SYS="SYS_META",K_PTR="PTR_SEQ",K_SEQ="PTR_COUNTER";
const K_LOCAIS="LOC_LIST",K_PESSOAS="PESSOAS";
const K_ATIV="CAT_ATIVIDADES",K_EQPT="CAT_EQUIPAMENTOS",K_RISCO="CAT_RISCOS";
const K_BP="BP_ALLOWED_GLOBAL",K_SIGN="SIGN_MODE",K_CRED="SYS_CREDITOS",K_LOGO="SYS_LOGO";
const K_AVB="AVAL_BASE",K_AVX="AVAL_XMAP"; // mapa checklist por atividade/risco/equip
const K_ARCH="PTR_ARCHIVE",K_LOGS="PTR_LOGS";
const K_REV="SYS_REV"; // revisão F-xxx / nn / dd/mm/aaaa

/* ===== logo & idioma/theme ===== */
(function initHeader(){
  const l=read(K_LOGO,null); if(l){const i=$("#logoHead"); i.src=l; i.style.display="block";}
  applyTheme(read("SYS_THEME","light"));
  i18n_setLang(read("SYS_LANG","pt-BR"));
})();

/* ===== prefill meta & revisão ===== */
const meta=read(K_SYS,{version:"1.0.0",revCode:"PTR-REV-A",revDate:todayISO(), empresa:"Mecalux do Brasil"});
$("#empresa").value = meta.empresa || "";
$("#data").value=todayISO(); $("#hora").value=nowTime();
const seqPattern=read(K_PTR,{pattern:"PTR-00001"}).pattern; let seq=read(K_SEQ,1);
function nextPTR(){const z=(seqPattern.match(/0/g)||[]).length||5;const num=String(seq).padStart(z,"0");return seqPattern.replace(/0+/,num)}
$("#ptrCodigo").value=nextPTR();

function fmtDateBR(d){const dt=new Date(d);const dd=("0"+dt.getDate()).slice(-2), mm=("0"+(dt.getMonth()+1)).slice(-2), yy=dt.getFullYear();return `${dd}/${mm}/${yy}`;}
const rev=read(K_REV,{prefix:"F-000",rev:0,date:fmtDateBR(new Date())});
function renderRev(){ $("#revText").textContent = `${rev.prefix} / ${String(rev.rev).padStart(2,"0")} / ${rev.date}`;}
renderRev();
$("#btnRevisar").onclick=()=>{ rev.rev++; rev.date=fmtDateBR(new Date()); write(K_REV,rev); renderRev(); };

/* ===== catálogos & pessoas (vêm do boot.js) ===== */
const locais = read(K_LOCAIS, BOOT.LOCATIONS);
const pessoas = read(K_PESSOAS, BOOT.PEOPLE);
const catAtividades = read(K_ATIV, BOOT.ACTIVITIES);
const catEquip = read(K_EQPT, BOOT.EQUIPMENTS);
const catRiscos = read(K_RISCO, BOOT.RISKS);
const baseItems = read(K_AVB, BOOT.CHECK_BASE);
const mapChecklist = read(K_AVX, BOOT.CHECK_MAP); // {activity:{}, risk:{}, equip:{}}

const bp=read(K_BP,["110/70","120/80","130/85"]);
const signMode=read(K_SIGN,"draw");
const creditos=read(K_CRED,{texto:"Sistema desenvolvido pela equipe do SGI da Mecalux do Brasil. Uso interno. Proibida cópia/venda sem autorização."});

/* ===== preencher selects e listas (com i18n dinâmico) ===== */
function labelLang(obj){return (obj.labels && obj.labels[i18n_lang]) || obj.name || obj;}
$("#setor").innerHTML = `<option value="">${i18n('select')}</option>` + locais.map(l=>`<option>${labelLang(l)}</option>`).join("");

function drawList(container, arr){
  container.innerHTML = arr.map(a=>`<label class="check"><input type="checkbox" value="${a.key||a.name||a}"> <span>${labelLang(a)}</span></label>`).join("");
}
drawList($("#listaAtividades"), catAtividades);
drawList($("#listaEquip"), catEquip);

/* ===== riscos por atividade (mostra nomes corretos) ===== */
function riscosByActivity(key){ // usa o catálogo RISKS com tags de activity key
  return catRiscos.filter(r => (r.activities||[]).includes(key));
}
function renderRiscos(){
  const atvs=$$("#listaAtividades input:checked").map(i=>i.value);
  let total=0;
  $("#riscosContainer").innerHTML = atvs.map(a=>{
    const ra=riscosByActivity(a);
    total+=ra.length;
    return `<div class="card thin">
      <div class="card-head"><h4>${labelLang(catAtividades.find(x=>x.key===a) || {name:a})}</h4>
        <span class="badge">${ra.length}</span></div>
      <div class="list">
        ${ra.map(r=>`<label class="check"><input type="checkbox" data-risk="${r.key}" checked> <span>${labelLang(r)}</span></label>`).join("")}
      </div>
    </div>`;
  }).join("") || `<p class="muted">${i18n('msg.select_activity')}</p>`;
  $("#risksCount").textContent = total? `${total} ${i18n('risks')}` : "—";
}

/* ===== checklist real (base + por atividade/risco/equipamento) ===== */
let allItems=[];
function radioRow(it){
  const critical = it.critico ? ` <strong class="crit">${i18n('critical')}</strong>` : "";
  return `<div class="list-row">
    <span>${labelLang(it)}${critical}</span>
    <div class="options-inline">
      <label class="check"><input type="radio" name="chk_${it.id}" value="SIM" checked> <span>${i18n('yes')}</span></label>
      <label class="check"><input type="radio" name="chk_${it.id}" value="NAO"> <span>${i18n('no')}</span></label>
      <label class="check"><input type="radio" name="chk_${it.id}" value="NA"> <span>${i18n('na')}</span></label>
    </div>
  </div>`;
}
function gatherChecklist(){
  const atvKeys=$$("#listaAtividades input:checked").map(i=>i.value);
  const eqKeys=$$("#listaEquip input:checked").map(i=>i.value);
  const riskKeys=$$("#riscosContainer input[type=checkbox]:checked").map(i=>i.getAttribute("data-risk"));

  const fromMap=(grp,keys)=> keys.flatMap(k=> (mapChecklist[grp][k]||[]));

  const items = [
    ...baseItems,
    ...fromMap('activity', atvKeys),
    ...fromMap('risk', riskKeys),
    ...fromMap('equip', eqKeys),
  ];

  // remover duplicados por id
  const seen=new Set(); const uniq=[];
  items.forEach(x=>{ if(!seen.has(x.id)){ seen.add(x.id); uniq.push(x); }});
  return uniq;
}
function renderAval(){
  allItems = gatherChecklist();
  $("#avaliacaoLista").innerHTML = allItems.map(radioRow).join("");
  $$(`#avaliacaoLista input[type=radio]`).forEach(r=>r.addEventListener("change",()=>{calcScore();updateNC();}));
  calcScore(); updateNC();
}
function calcScore(){
  let s=100;
  for(const it of allItems){
    const v=(document.querySelector(`input[name="chk_${it.id}"]:checked`)||{}).value||"SIM";
    if(v==="NAO"){ if(it.critico){s=0;break;} s-=Number(it.peso||10); }
  }
  s=Math.max(0,Math.min(100,s));
  $("#scoreBadge").textContent=`${i18n('score')}: ${s}`;
  $("#scoreLegenda").textContent = s===0?`0 • ${i18n('score.block')}`:
    s<=25?`${s} • ${i18n('score.critical')}`:
    s<=50?`${s} • ${i18n('score.need_tst')}`:
    s<=75?`${s} • ${i18n('score.need_actions')}`:
    `${s} • ${i18n('score.ok')}`;
  return s;
}
function updateNC(){
  const linhas=[];
  for(const it of allItems){
    const v=(document.querySelector(`input[name="chk_${it.id}"]:checked`)||{}).value||"SIM";
    if(v==="NAO") linhas.push(`- ${it.critico?"[Crítico] ":""}${labelLang(it)}`);
  }
  const ta=$("#logNC"); if(!ta._touched || !ta.value.trim()){ ta.value = linhas.join("\n"); }
}
$("#logNC").addEventListener("input",e=>e.target._touched=true);

/* ===== eventos que impactam riscos e checklist ===== */
$("#listaAtividades").addEventListener("change",()=>{renderRiscos(); renderAval();});
$("#listaEquip").addEventListener("change",()=>{renderAval();});
document.addEventListener("change",e=>{
  if(e.target.matches("#riscosContainer input[type=checkbox]")) renderAval();
});
renderRiscos(); renderAval();

/* ===== executantes + assinaturas (mesmo comportamento anterior) ===== */
function isAlturaOuConfinado(){
  const a=$$("#listaAtividades input:checked").map(i=>i.value);
  return a.includes("trabalho_altura") || a.includes("espaco_confinado");
}
function renderSelExec(){
  const execs=pessoas.filter(p=>p.perm?.exec);
  $("#selExecutante").innerHTML=`<option value="">${i18n('select')}</option>`+execs.map(p=>`<option value="${p.id}">${p.nome} (${p.cpf})</option>`).join("");
}
renderSelExec();

function mountSig(container,mode){ // igual à versão anterior (desenho/câmera/upload)
  container._dirty=false; container._saved=null;
  const fitSize = () => Math.max(260, Math.min(560, Math.floor(container.clientWidth || 420)));

  if(mode==="draw"){
    const c=document.createElement("canvas");
    const setSize = () => { c.width=fitSize(); c.height=Math.round(c.width*0.36); c.style.width="100%"; c.style.height="auto";
      c.style.background="#fff"; c.style.border="1px dashed var(--border)"; c.style.borderRadius="12px"; };
    setSize(); new ResizeObserver(setSize).observe(container);

    container.innerHTML=""; container.appendChild(c);
    const ctx=c.getContext("2d"); ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="var(--ink)";
    let draw=false,last=null; const pos=e=>{const r=c.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}
    const start=e=>{draw=true; last=pos(e)}; const move=e=>{if(!draw)return;const p=pos(e);ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;container._dirty=true}; const end=()=>draw=false;
    c.addEventListener("mousedown",start);c.addEventListener("mousemove",move);window.addEventListener("mouseup",end);
    c.addEventListener("touchstart",start,{passive:true});c.addEventListener("touchmove",move,{passive:true});c.addEventListener("touchend",end,{passive:true});
    container._getData=()=> container._dirty ? (container._saved || c.toDataURL("image/png")) : null;
    container._clear=()=>{ctx.clearRect(0,0,c.width,c.height);container._dirty=false;container._saved=null;}
    return;
  }
  // modo "upload" simplificado
  container.innerHTML=`<input type="file" accept="image/*" class="upSig"><img class="sign-pad-img" style="display:none">`;
  const inp=container.querySelector(".upSig"), img=container.querySelector("img");
  inp.addEventListener("change",()=>{const f=inp.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{img.src=r.result;img.style.display="block";container._dirty=true};r.readAsDataURL(f);});
  container._getData=()=> container._dirty ? img.src : null;
  container._clear=()=>{img.src="";img.style.display="none";inp.value="";container._dirty=false}
}
function linhaExec(p){
  const precisaPA=isAlturaOuConfinado();
  return `<div class="card thin" data-person="${p.id}">
    <div class="card-head"><h4>${p.nome}</h4><span class="badge">—</span></div>
    ${precisaPA?`<div class="grid">
      <label class="field"><span>${i18n('bp.label')}</span><input class="inp-pa" type="text" placeholder="120/80"></label>
      <label class="check" style="align-self:end;"><input class="inp-pa-na" type="checkbox"> <span>${i18n('bp.na')}</span></label>
    </div>`:`<p class="muted">${i18n('bp.not_required')}</p>`}
    <div class="field" style="margin-top:8px;"><span>${i18n('fields.signature')}</span><div class="signpad"></div></div>
    <div class="row-actions" style="margin-top:6px;">
      <button class="btn" data-save>${i18n('btn.save_sign')}</button>
      <button class="btn ghost" data-clear>${i18n('btn.clear')}</button>
      <button class="btn ghost" data-rem>${i18n('btn.remove')}</button>
    </div>
  </div>`;
}
function paOk(str,na){ if(na) return true; if(!str) return false; const v=str.replace(/\s+/g,""); return bp.includes(v); }
function treinaOk(p,atvs){ const h=new Date();h.setHours(0,0,0,0); const v35=!p.tr35||new Date(p.tr35)<h; const v33=!p.tr33||new Date(p.tr33)<h; if(atvs.includes("trabalho_altura")&&v35) return false; if(atvs.includes("espaco_confinado")&&v33) return false; return true; }
function refreshExecCard(card,id){
  const atvs=$$("#listaAtividades input:checked").map(i=>i.value), p=pessoas.find(x=>String(x.id)===String(id));
  const okPA=!isAlturaOuConfinado()?true:paOk(card.querySelector(".inp-pa")?.value, card.querySelector(".inp-pa-na")?.checked);
  const okTR=treinaOk(p,atvs);
  const ok=okPA&&okTR; const b=card.querySelector(".badge"); b.textContent=ok?i18n('fit'):i18n('unfit'); b.className=`badge ${ok?'good':'bad'}`; return ok;
}
$("#addExec").onclick=()=>{
  const id=$("#selExecutante").value; if(!id || $(`#execList [data-person="${id}"]`)) return;
  const p=pessoas.find(x=>String(x.id)===String(id)); const wrap=document.createElement("div"); wrap.innerHTML=linhaExec(p); const card=wrap.firstElementChild; $("#execList").appendChild(card);
  const pad=card.querySelector(".signpad"); mountSig(pad,signMode);
  card.addEventListener("click",(e)=>{
    if(e.target.hasAttribute("data-rem")) card.remove();
    if(e.target.hasAttribute("data-save")){ const d=pad._getData?.(); if(!d){alert(i18n('msg.empty_sign'));return;} pad._saved=d; alert(i18n('msg.saved')); }
    if(e.target.hasAttribute("data-clear")){ pad._clear?.(); pad._saved=null; }
  });
  card.addEventListener("input",()=>refreshExecCard(card,id));
  refreshExecCard(card,id);
};
$("#listaAtividades").addEventListener("change",()=> $$("#execList .card").forEach(c=>refreshExecCard(c,c.dataset.person)));

/* Assinaturas Responsáveis */
function attachRespButtons(){
  $$("[data-save-role]").forEach(btn=>{
    const role=btn.getAttribute("data-save-role"); btn.onclick=()=>{ const box=$(`.signpad[data-role="${role}"]`); const d=box._getData?.(); if(!d){alert(i18n('msg.empty_sign'));return;} box._saved=d; alert(i18n('msg.saved')); };
  });
  $$("[data-clear-role]").forEach(btn=>{
    const role=btn.getAttribute("data-clear-role"); btn.onclick=()=>{ const box=$(`.signpad[data-role="${role}"]`); box._clear?.(); box._saved=null; };
  });
}
$$(".signpad[data-role]").forEach(box=>mountSig(box,signMode));
attachRespButtons();

/* rascunho/cancelar */
$("#btnSalvarRascunho").onclick=()=>{ write("PTR_DRAFT",collect()); alert(i18n('msg.draft_saved')); };
$("#btnCancelar").onclick=()=>{ if(confirm(i18n('msg.discard'))){ localStorage.removeItem("PTR_DRAFT"); location.reload(); } };

/* coletar/validar/relatório/pdf/zip – igual base com textos i18n */
function collect(){
  const atvs=$$("#listaAtividades input:checked").map(i=>i.value);
  const eqps=$$("#listaEquip input:checked").map(i=>i.value);
  const riscos=Array.from($("#riscosContainer").querySelectorAll(".card.thin")).map(card=>{
    const titulo=card.querySelector("h4")?.textContent||""; const rs=Array.from(card.querySelectorAll("input[type=checkbox]")).map(c=>({nome:c.parentElement.textContent.trim(),marcado=c.checked}));
    return {atividade:titulo,riscos:rs};
  });
  const aval={}; for(const it of allItems){ aval[it.id]=(document.querySelector(`input[name="chk_${it.id}"]:checked`)||{}).value||"SIM"; }
  const nc_items=Object.keys(aval).filter(id=>aval[id]==="NAO").map(id=>allItems.find(x=>x.id===id)).filter(Boolean).map(it=>({texto:labelLang(it),critico:!!it.critico}));
  const execs=$$("#execList .card").map(card=>{
    const id=card.dataset.person, p=pessoas.find(x=>String(x.id)===String(id));
    const pa=card.querySelector(".inp-pa")?.value||"", paNA=card.querySelector(".inp-pa-na")?.checked||false;
    const apto=card.querySelector(".badge")?.classList.contains("good");
    const pad=card.querySelector(".signpad"); const sig=pad? (pad._saved||pad._getData?.()||null):null; const signed=pad? (pad._dirty||!!pad._saved):false;
    return {id,nome:p?.nome,cpf:p?.cpf,pa,paNA,apto,assinatura:sig,_signed:signed};
  });
  const r={emissor:$("#respEmissor").value||"",lider:$("#respLider").value||"",resp:$("#respEquipe").value||""};
  const sE=$(`.signpad[data-role="emissor"]`), sL=$(`.signpad[data-role="lider"]`), sR=$(`.signpad[data-role="resp"]`);
  const ass={emissor:(sE._saved||sE._getData?.()||null),lider:(sL._saved||sL._getData?.()||null),resp:(sR._saved||sR._getData?.()||null)};
  const dirty={emissor:!!(sE._dirty||sE._saved),lider:!!(sL._dirty||sL._saved),resp:!!(sR._dirty||sR._saved)};
  return {
    empresa:$("#empresa").value.trim(), ptr:$("#ptrCodigo").value.trim(), data:$("#data").value, hora:normTime(),
    setor:$("#setor").value, atividadeDesc:$("#atividadeDesc").value.trim(),
    atividades:atvs, equipamentos:eqps, riscos, avaliacao:aval, score:calcScore(),
    naoConformidades:{itens:nc_items, texto:$("#logNC").value},
    executantes:execs, responsaveis:r, assinaturaResp:ass, _dirtyResp:dirty,
    _meta:meta, _creditos:creditos
  };
}
function validate(p){
  const timeOK=/^([01]\d|2[0-3]):([0-5]\d)$/.test(p.hora);
  if(!p.empresa||!p.ptr||!p.data||!timeOK||!p.setor){ alert(i18n('val.fill_required')); return false; }
  if(!p.atividades.length){ alert(i18n('val.select_activity')); return false; }
  if(!p.executantes.length){ alert(i18n('val.add_executor')); return false; }
  for(const e of p.executantes){ if(!e._signed||!e.assinatura){ alert(i18n('val.exec_sign').replace('%',e.nome)); return false; } if(!e.apto){ alert(i18n('val.exec_unfit').replace('%',e.nome)); return false; } }
  if(!p.responsaveis.emissor||!p.responsaveis.lider||!p.responsaveis.resp){ alert(i18n('val.select_responsibles')); return false; }
  if(!p._dirtyResp.emissor||!p._dirtyResp.lider||!p._dirtyResp.resp||!p.assinaturaResp.emissor||!p.assinaturaResp.lider||!p.assinaturaResp.resp){ alert(i18n('val.sign_resp')); return false; }
  if(p.score<=25){ alert(i18n('val.score_block').replace('%',p.score)); return false; }
  return true;
}
function fillReport(p,uid,hash){
  const nomePorId=id=>(pessoas.find(x=>String(x.id)===String(id))||{}).nome||"—";
  const set=(id,html)=>$("#"+id).innerHTML=html;
  const logo=read(K_LOGO,null); const repLogo=$("#repLogo"); if(logo){repLogo.src=logo;} else {repLogo.removeAttribute("src");}
  set("repInfo",`<h4>${i18n('rep.data')}</h4><p><b>${i18n('fields.company')}:</b> ${p.empresa}</p><p><b>PTR:</b> ${p.ptr}</p><p><b>${i18n('fields.date')}:</b> ${p.data} • <b>${i18n('fields.time')}:</b> ${p.hora}</p><p><b>${i18n('fields.sector')}:</b> ${p.setor}</p><p><b>${i18n('fields.activity_desc')}:</b> ${p.atividadeDesc||"—"}</p>`);
  set("repMeta",`<h4>${i18n('rep.meta')}</h4><p><b>${i18n('rep.version')}:</b> v${p._meta.version}</p><p><b>${i18n('rep.revision')}:</b> ${p._meta.revCode} • ${p._meta.revDate}</p><p><b>${i18n('rep.uid_short')}:</b> ${uid}</p>`);
  set("repAtividades",`<h4>${i18n('rep.activities')}</h4><ul>${p.atividades.map(a=>`<li>${labelLang(catAtividades.find(x=>x.key===a)||{name:a})}</li>`).join("")}</ul>`);
  set("repRiscos",`<h4>${i18n('rep.risks')}</h4>${p.riscos.map(r=>`<div><b>${r.atividade}</b><ul>${r.riscos.filter(x=>x.marcado).map(x=>`<li>${x.nome}</li>`).join("")||"<li>—</li>"}</ul></div>`).join("")}`);
  set("repEquip",`<h4>${i18n('rep.equip')}</h4><ul>${p.equipamentos.map(e=>`<li>${labelLang(catEquip.find(x=>x.key===e)||{name:e})}</li>`).join("")||"<li>—</li>"}</ul>`);
  set("repScore",`<h4>Score</h4><p><b>${p.score}</b></p>`);
  set("repExecutantes",`<h4>${i18n('rep.executors')}</h4>${p.executantes.map(e=>`<div style="margin:6px 0"><div><b>${e.nome}</b> (${e.cpf}) — ${e.apto?i18n('fit'):i18n('unfit')}</div><div>${i18n('bp.short')}: ${e.paNA?"N/A":(e.pa||"—")}</div>${e.assinatura?`<img class="sign-pad-img" src="${e.assinatura}">`:""}</div>`).join("")}`);
  set("repResponsaveis",`<h4>${i18n('rep.responsibles')}</h4>
    <div><b>${i18n('fields.emissor')}:</b> ${nomePorId(p.responsaveis.emissor)}</div>${p.assinaturaResp.emissor?`<img class="sign-pad-img" src="${p.assinaturaResp.emissor}">`:""}
    <div style="margin-top:6px"><b>${i18n('fields.leader')}:</b> ${nomePorId(p.responsaveis.lider)}</div>${p.assinaturaResp.lider?`<img class="sign-pad-img" src="${p.assinaturaResp.lider}">`:""}
    <div style="margin-top:6px"><b>${i18n('fields.team_resp')}:</b> ${nomePorId(p.responsaveis.resp)}</div>${p.assinaturaResp.resp?`<img class="sign-pad-img" src="${p.assinaturaResp.resp}">`:""}`);
  const ncText = (p.naoConformidades?.texto||"").split(/\r?\n/).filter(Boolean).map(s=>`<li>${s.replace(/^-+\s*/,'')}</li>`).join("") || "<li>—</li>";
  set("repNC",`<h4>${i18n('rep.nc')}</h4><ul>${ncText}</ul>`);
  set("repCreditos",`<h4>${i18n('rep.credits')}</h4><p>${p._creditos.texto}</p>`);
  $("#repUUID").textContent=uid; $("#repTs").textContent=new Date().toLocaleString(); $("#repHash").textContent=hash;
}
async function renderPDF(){
  const {jsPDF}=window.jspdf; const node=$("#report");
  const canvas=await html2canvas(node,{scale:2,useCORS:true,backgroundColor:"#ffffff"});
  const pdf=new jsPDF({unit:"pt",format:"a4"});
  const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
  const imgW=pw-40, ratio=imgW/canvas.width, pageHpx=(ph-40)/ratio;
  let sY=0, first=true;
  while(sY<canvas.height){
    const c=document.createElement("canvas"); c.width=canvas.width; c.height=Math.min(pageHpx, canvas.height-sY);
    c.getContext("2d").drawImage(canvas,0, sY, canvas.width, c.height, 0,0,c.width,c.height);
    if(!first) pdf.addPage(); first=false; pdf.addImage(c.toDataURL("image/png"),"PNG",20,20,imgW,c.height*ratio,"","FAST");
    sY+=pageHpx;
  }
  return pdf.output("blob");
}
$("#btnConcluir").onclick=async()=>{
  const p=collect(); if(!validate(p)) return;
  write(K_SEQ, ++seq);

  const json=JSON.stringify(p), hash=await sha256Hex(json), uid=uuid();
  fillReport(p,uid,hash);

  const base=p.ptr.replace(/[^A-Za-z0-9]/g,"");
  const d=new Date(p.data+"T"+(p.hora||"00:00")), dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"), yyyy=d.getFullYear();
  const pdfName=`${base}-${dd}-${mm}-${yyyy}.pdf`, jsonName=`${base}-${dd}-${mm}-${yyyy}.json`;
  const pdfBlob=await renderPDF();

  const zip=new JSZip();
  zip.file(pdfName,pdfBlob); zip.file(jsonName,json);
  p.executantes.forEach((e,i)=>{ if(e.assinatura){ zip.file(`assinaturas/executantes/${i+1}-${(e.nome||"exec")}.png`, e.assinatura.split(",")[1], {base64:true}); }});
  if(p.assinaturaResp.emissor) zip.file(`assinaturas/responsaveis/1-emissor.png`, p.assinaturaResp.emissor.split(",")[1],{base64:true});
  if(p.assinaturaResp.lider)   zip.file(`assinaturas/responsaveis/2-lider.png`,   p.assinaturaResp.lider.split(",")[1],  {base64:true});
  if(p.assinaturaResp.resp)    zip.file(`assinaturas/responsaveis/3-responsavel.png`, p.assinaturaResp.resp.split(",")[1],{base64:true});
  const zipBlob=await zip.generateAsync({type:"blob"});
  saveAs(zipBlob, `${base}-${dd}-${mm}-${yyyy}.zip`);
  saveAs(pdfBlob, pdfName);

  // arquiva para dashboard/relatórios com status liberada x não liberada
  const liberada = p.score>75;
  const archive=read(K_ARCH,[]); archive.push({status:liberada?'liberada':'nao_liberada', ptr:p.ptr, data:p.data, atividades:p.atividades, equipamentos:p.equipamentos, createdAt:new Date().toISOString(), json:p});
  write(K_ARCH,archive);

  const logs=read(K_LOGS,[]); p.atividades.forEach(a=>logs.push({type:"atividade",nome:a,data:p.data,createdAt:new Date().toISOString()}));
  p.equipamentos.forEach(e=>logs.push({type:"equip",nome:e,data:p.data,createdAt:new Date().toISOString()}));
  p.executantes.forEach(x=>logs.push({type:"executor",nome:x.nome,data:p.data,createdAt:new Date().toISOString()}));
  write(K_LOGS,logs);

  alert(i18n('msg.done'));
};

/* popula responsáveis e empresa default */
(function fillPeople(){
  const resp = pessoas.filter(p=>p.perm?.resp);
  ["respEmissor","respLider","respEquipe"].forEach(id=>{
    $("#"+id).innerHTML = `<option value="">${i18n('select')}</option>` + resp.map(p=>`<option value="${p.id}">${p.nome}</option>`).join("");
  });
  if(!$("#empresa").value) $("#empresa").value = "Mecalux do Brasil";
})();
</script>
</body>
</html>
