<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title data-i18n="nav.settings">Configurações</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="i18n.js"></script>
  <script src="boot.js"></script>
</head>
<body>
<header class="header-inline">
  <img id="logoHead" alt="logo" style="display:none">
  <h1 data-i18n="nav.settings">Configurações</h1>
</header>

<nav class="navbar">
  <a href="index.html" data-i18n="nav.home">Início</a>
  <a href="dashboard.html" data-i18n="nav.dashboard">Dashboard</a>
  <a href="reports.html" data-i18n="nav.reports">Relatórios</a>
  <a href="help.html" data-i18n="nav.help">Ajuda</a>
</nav>

<main class="steps" id="root">
  <!-- Preferências -->
  <section class="card">
    <div class="card-head"><h3>Preferências</h3></div>
    <div class="grid">
      <label class="field">
        <span>Idioma</span>
        <select id="langSel">
          <option value="pt-BR">Português-BR</option>
          <option value="es">Español</option>
          <option value="en">English</option>
        </select>
      </label>

      <label class="field">
        <span>Tema</span>
        <select id="themeSel">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </label>

      <label class="field">
        <span>Empresa (padrão)</span>
        <input id="empresaPadrao" type="text" placeholder="Mecalux do Brasil">
      </label>

      <label class="field">
        <span>Padrão do código sequencial</span>
        <input id="seqPattern" type="text" placeholder="PTR-00001">
      </label>
    </div>
  </section>

  <!-- Revisão F-000 / 00 / dd/mm/aaaa -->
  <section class="card">
    <div class="card-head"><h3>Revisão do Documento</h3></div>
    <div class="grid">
      <label class="field"><span>Prefixo</span><input id="revPrefix" type="text" placeholder="F-000"></label>
      <label class="field"><span>Nº Revisão</span><input id="revNum" type="number" min="0" step="1"></label>
      <label class="field"><span>Data</span><input id="revDate" type="text" placeholder="dd/mm/aaaa"></label>
    </div>
    <p class="muted">Na página inicial há o botão “Revisar?” que incrementa a revisão e atualiza a data automaticamente.</p>
  </section>

  <!-- Logo -->
  <section class="card">
    <div class="card-head"><h3>Logo</h3></div>
    <div class="grid">
      <label class="field">
        <span>Enviar imagem (rodapé/cabeçalho)</span>
        <input id="logoInput" type="file" accept="image/*">
      </label>
      <div class="field">
        <span>Pré-visualização</span>
        <img id="logoPreview" style="max-height:40px;display:block">
      </div>
    </div>
  </section>

  <!-- Catálogos -->
  <section class="card">
    <div class="card-head"><h3>Catálogos</h3></div>

    <div class="grid">
      <label class="field">
        <span>Tipos de Atividade</span>
        <textarea id="catAtv" class="notes" placeholder="key;pt-BR;es;en&#10;trabalho_altura;Trabalho em Altura;Trabajo en Altura;Working at Height"></textarea>
      </label>

      <label class="field">
        <span>Equipamentos</span>
        <textarea id="catEq" class="notes" placeholder="key;pt-BR;es;en&#10;pea;Plataforma Elevatória;Plataforma Elevadora;Boom Lift"></textarea>
      </label>

      <label class="field">
        <span>Riscos</span>
        <textarea id="catRisco" class="notes" placeholder="key;activities(comma);pt-BR;es;en&#10;queda_pessoa;trabalho_altura;Queda de pessoas;Caída de personas;Fall of people"></textarea>
      </label>
    </div>

    <p class="muted">Formato linha por linha. Salve para aplicar.</p>
    <button id="saveCatalogs" class="btn primary">Salvar Catálogos</button>
  </section>

  <!-- Checklist base e por chave -->
  <section class="card">
    <div class="card-head"><h3>Checklist (Base / Atividade / Risco / Equip.)</h3></div>
    <div class="grid">
      <label class="field">
        <span>Base (JSON)</span>
        <textarea id="chkBase" class="notes" placeholder='[ { "id":"base_trein","critico":true,"peso":100,"labels":{"pt-BR":"...","es":"...","en":"..."} } ]'></textarea>
      </label>
      <label class="field">
        <span>Mapa (JSON)  — keys: activity / risk / equip</span>
        <textarea id="chkMap" class="notes" placeholder='{ "activity": { "trabalho_altura":[ { "id":"atv_alt_anc","peso":20,"labels":{"pt-BR":"..."} } ] }, "risk":{}, "equip":{} }'></textarea>
      </label>
    </div>
    <button id="saveChk" class="btn">Salvar Checklist</button>
  </section>

  <section class="card">
    <div class="card-head"><h3>Créditos</h3></div>
    <label class="field">
      <span>Texto</span>
      <textarea id="credTxt" class="notes" placeholder="Sistema desenvolvido pela equipe do SGI da Mecalux do Brasil. Uso interno..."></textarea>
    </label>
    <button id="saveAll" class="btn primary">Salvar Tudo</button>
  </section>
</main>

<script>
const $=s=>document.querySelector(s), read=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}, write=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

const K_LOGO="SYS_LOGO",K_PTR="PTR_SEQ",K_SYS="SYS_META",K_REV="SYS_REV",K_ATIV="CAT_ATIVIDADES",K_EQPT="CAT_EQUIPAMENTOS",K_RISCO="CAT_RISCOS",K_AVB="AVAL_BASE",K_AVX="AVAL_XMAP";

// carrega preferências iniciais
(function load(){
  i18n_setLang(localStorage.getItem('SYS_LANG')||'pt-BR');
  applyTheme(localStorage.getItem('SYS_THEME')||'light');

  const meta = read(K_SYS,{empresa:"Mecalux do Brasil",version:"1.0.0",revCode:"PTR-REV-A",revDate:new Date().toISOString().slice(0,10)});
  $("#empresaPadrao").value = meta.empresa || "";
  $("#seqPattern").value   = (read(K_PTR,{pattern:"PTR-00001"}).pattern);

  const rev = read(K_REV,{prefix:"F-000",rev:0,date:new Date().toLocaleDateString('pt-BR')});
  $("#revPrefix").value = rev.prefix; $("#revNum").value = rev.rev; $("#revDate").value = rev.date;

  const logo = read(K_LOGO,null); if(logo){ $("#logoPreview").src = logo; $("#logoHead").src=logo; $("#logoHead").style.display="block"; }

  // catálogos → texto
  const atv = read(K_ATIV, BOOT.ACTIVITIES);
  $("#catAtv").value = atv.map(a=>`${a.key};${a.labels["pt-BR"]};${a.labels["es"]};${a.labels["en"]}`).join("\n");

  const eq = read(K_EQPT, BOOT.EQUIPMENTS);
  $("#catEq").value = eq.map(a=>`${a.key};${a.labels["pt-BR"]};${a.labels["es"]};${a.labels["en"]}`).join("\n");

  const rk = read(K_RISCO, BOOT.RISKS);
  $("#catRisco").value = rk.map(r=>`${r.key};${(r.activities||[]).join(',')};${r.labels["pt-BR"]};${r.labels["es"]};${r.labels["en"]}`).join("\n");

  $("#chkBase").value = JSON.stringify(read(K_AVB, BOOT.CHECK_BASE), null, 2);
  $("#chkMap").value  = JSON.stringify(read(K_AVX, BOOT.CHECK_MAP), null, 2);

  $("#langSel").value  = localStorage.getItem('SYS_LANG')||'pt-BR';
  $("#themeSel").value = localStorage.getItem('SYS_THEME')||'light';
})();

// eventos
$("#langSel").addEventListener("change", e=>{ i18n_setLang(e.target.value); });
$("#themeSel").addEventListener("change", e=>{ applyTheme(e.target.value); });

$("#logoInput").addEventListener("change", ()=>{
  const f=$("#logoInput").files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ write(K_LOGO,r.result); $("#logoPreview").src=r.result; $("#logoHead").src=r.result; $("#logoHead").style.display="block"; };
  r.readAsDataURL(f);
});

$("#saveCatalogs").onclick=()=>{
  function parseCat(txt, isRisk=false){
    const out=[]; txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).forEach(line=>{
      const parts=line.split(';'); if(isRisk){
        const [key,acts,pt,es,en]=parts;
        out.push({key,activities:(acts||"").split(',').filter(Boolean),labels:{"pt-BR":pt,"es":es,"en":en}});
      } else {
        const [key,pt,es,en]=parts;
        out.push({key,labels:{"pt-BR":pt,"es":es,"en":en}});
      }
    }); return out;
  }
  write(K_ATIV, parseCat($("#catAtv").value));
  write(K_EQPT, parseCat($("#catEq").value));
  write(K_RISCO, parseCat($("#catRisco").value, true));
  alert("Catálogos salvos.");
};

$("#saveChk").onclick=()=>{
  try{
    const base = JSON.parse($("#chkBase").value||"[]");
    const map  = JSON.parse($("#chkMap").value||"{}");
    write(K_AVB, base); write(K_AVX, map);
    alert("Checklist salvo.");
  }catch{ alert("JSON inválido."); }
};

$("#saveAll").onclick=()=>{
  const meta = read(K_SYS,{});
  meta.empresa = $("#empresaPadrao").value || "Mecalux do Brasil";
  write(K_SYS, meta);

  write("PTR_SEQ", {pattern: $("#seqPattern").value || "PTR-00001"});

  write(K_REV, {prefix:$("#revPrefix").value||"F-000", rev: parseInt($("#revNum").value||"0",10), date: $("#revDate").value|| new Date().toLocaleDateString('pt-BR')});

  alert("Preferências salvas.");
};
</script>
</body>
</html>
